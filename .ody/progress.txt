2026-01-29: Added --provider/--model args to init to persist optional config fields; marked PRD complete.
2026-02-03: Added basic Bun tests for Test task (Test 1/2) and marked PRD entry complete.
2026-02-03: Added `ody plan` command stub with console message; marked PRD entry complete.
2026-02-03: Implemented interactive `ody plan` prompts using @clack/prompts and console output; marked PRD entry complete.
2026-02-05: Fixed proc.kill(0) zombie process bug — replaced proc.kill(0) with proc.kill() + await proc.exited in run.ts loop mode, removed unnecessary proc.kill(exitCode) in run.ts once mode, replaced proc.kill(0) with proc.kill() in plan.ts; marked PRD entry complete.
2026-02-05: Fixed stderr pipe deadlock — changed stdio from ['ignore','pipe','pipe'] to ['ignore','pipe','inherit'] in run.ts and plan.ts so stderr flows directly to the terminal instead of filling an unread pipe buffer; marked PRD entry complete.
2026-02-05: Fixed maxIterations: 0 bug — updated for-loop in run.ts to treat 0 as infinite (`maxIterations === 0 || i < maxIterations`), added `.int().nonnegative()` constraints to zod schema in config.ts; marked PRD entry complete.
2026-02-05: Fixed silent swallowing of non-Error exceptions — added else branches to all 4 catch blocks (config.ts, init.ts, run.ts x2) so non-Error thrown values (strings, objects, ZodError) are logged via String(err) and trigger process.exit(1) instead of being silently ignored; marked PRD entry complete.
2026-02-05: Made Claude --dangerously-skip-permissions flag configurable — added optional `skipPermissions` boolean (default true) to zod config schema, added confirm prompt during `ody init` when backend is claude, updated claude.ts to conditionally include the flag based on config; marked PRD entry complete.
2026-02-05: Added plan iteration loop — wrapped the entire plan flow in a while loop with a "Would you like to add another plan?" confirm prompt after each iteration; user can create multiple plans in one session or decline to exit gracefully; also handles cancel (Ctrl+C) at the confirm prompt; marked PRD entry complete.
2026-02-05: Added verbose stderr logging to run command — when --verbose is passed, stderr is piped instead of inherited and drained concurrently via an async IIFE that logs each chunk through logger.warn, preventing buffer deadlock while keeping stderr as 'inherit' when verbose is off; marked PRD entry complete.
2026-02-05: Added verbose stderr logging to plan command — mirrored the run command pattern: when --verbose is passed, stderr stdio changes from 'inherit' to 'pipe' and is drained concurrently via an async IIFE that logs each chunk through logger.warn; stderr remains 'inherit' when verbose is off; stdout completion marker detection is unaffected; marked PRD entry complete.
2026-02-10: Completed task 'Add Unit Tests for Util Modules' - Created 3 test files (constants.test.ts, stream.test.ts, inputPrompt.test.ts) with 21 passing tests covering all util modules. All tests pass via 'bun test packages/cli/src/util'.
2026-02-10: Completed task - Configurable Tasks Directory. Added tasksDir config option with default '.ody/tasks', updated LOOP_PROMPT and PLAN_PROMPT to use dynamic path substitution.
2026-02-10: Added label filter flag (-l/--label) to run command with task filtering and dry-run integration
2026-02-10: Removed confirmation prompt from plan command — removed the box() display and confirm() prompt that asked "Proceed with these plan details?" after entering a task description. Plan generation now starts immediately after the user submits their description, reducing friction. Cleaned up unused imports (box, cancel).
2026-02-10: Added `ody config` command — created packages/cli/src/cmd/config.ts that displays current configuration from .ody/ody.json using Config.all(), registered it as a subcommand in index.ts. Handles missing config gracefully with a helpful message.
2026-02-10: Added --iterations/-i flag to run command — allows overriding maxIterations config at invocation time. Validates input as non-negative integer, supports 0 for unlimited. No effect in --once mode. All validation commands pass.
2026-02-10: Added PTY-based completion detection to --once mode — replaced inherited stdio with Bun.Terminal PTY API in run.ts so the <woof>COMPLETE</woof> marker is detected and the process is killed automatically, while preserving full interactive TTY behavior for the child process.
2026-02-10: Added `plan list` subcommand — restructured plan.ts to support subcommands using citty's subCommands pattern. Existing plan creation logic preserved as default behavior (`ody plan`) and also available as `ody plan create`. New `list` subcommand reads .code-task.md files from the tasks directory, parses YAML frontmatter, and displays pending tasks with titles and filenames. Handles missing directory and no-pending-tasks cases gracefully.
2026-02-10: Added OS notifications on completion — created packages/cli/src/lib/notify.ts with cross-platform sendNotification() using osascript (macOS) and notify-send (Linux). Added `notify` config field (false | true | 'all' | 'individual') to Zod schema, --no-notify flag to run command, and notification prompt to init wizard. Notifications fire on loop completion ('all'), per iteration ('individual'), or in single-shot mode.
2026-02-10: Added global config file support — refactored Config.load() in packages/cli/src/lib/config.ts to detect and load a global config from ~/.ody/ody.json (with XDG fallback at ~/.config/ody/ody.json). Global config is merged with local project config, with local values taking precedence. Uses Bun.env.HOME with os.homedir() fallback for cross-platform home directory detection. Fully backward-compatible — existing setups without global config continue to work unchanged.
2026-02-10: Added `plan edit` subcommand — added an `edit` subcommand to the plan command that discovers .code-task.md files in the tasks directory, presents a select prompt for the user to choose a file, reads its content, constructs an edit prompt, and spawns the backend harness in build mode to edit the file. Supports --dry-run and --verbose flags. Registered as `ody plan edit` alongside existing create and list subcommands.
2026-02-10: Added task file positional argument to run command — `ody run <file>` now accepts an optional positional argument pointing to a specific .code-task.md file. When provided, the agent targets only that task (using a dedicated SINGLE_TASK_PROMPT), defaults to 1 iteration, and exits on completion. Validates file existence and extension; mutually exclusive with --label. Works in both loop and --once modes. Updated buildRunPrompt in runPrompt.ts to support the taskFile option.
2026-02-10: Added `plan compact` subcommand — archives completed tasks into a single markdown file at .ody/history/archive-{date}.md. Scans .code-task.md files, filters for status: completed, extracts titles and condensed descriptions, sorts by completion date, writes the archive, and deletes original completed task files. Handles edge cases (no tasks directory, no completed tasks, empty directory).
2026-02-12: Added configurable `agent` field to ody config — added optional `agent` string (default 'build') to the zod config schema, updated Backend.buildCommand and buildOnceCommand to read from config instead of hardcoding 'build', and added --agent/-a flag and interactive prompt to the init command for persisting the value.
2026-02-12: Added unit tests for lib directory — created packages/cli/src/lib/__tests__/ with four test files: sequencer.test.ts (pure-function incrementing counter tests), config.test.ts (Config.parse validation with valid/invalid inputs, access guard tests for all() and get()), notify.test.ts (platform-branching behavior, error swallowing, and contract tests for sendNotification), and logger.test.ts (level check, fatal reporter triggers process.exit). 35 new tests, all passing. Full suite: 56 tests across 7 files.
2026-02-13: Removed --once flag and logic from run command — deleted --once and --dry-run arg definitions and the entire PTY-based single-execution code path from run.ts, removed buildOnceCommand abstract method from Harness base class, removed buildOnceCommand from Backend facade, and removed buildOnceCommand implementations from claude.ts, opencode.ts, and codex.ts. Updated plan edit subcommand to use buildCommand with piped stdio instead of buildOnceCommand. Updated README.md to remove --once and --dry-run references. All validation commands pass (lint, fmt, typecheck).
2026-02-15: Completed task 'Write Test File to ./test/1.txt' — created test/1.txt with content "TEST 1", verified file exists with correct content. All validation commands pass.
