2026-01-29: Added --provider/--model args to init to persist optional config fields; marked PRD complete.
2026-02-03: Added basic Bun tests for Test task (Test 1/2) and marked PRD entry complete.
2026-02-03: Added `ody plan` command stub with console message; marked PRD entry complete.
2026-02-03: Implemented interactive `ody plan` prompts using @clack/prompts and console output; marked PRD entry complete.
2026-02-05: Fixed proc.kill(0) zombie process bug — replaced proc.kill(0) with proc.kill() + await proc.exited in run.ts loop mode, removed unnecessary proc.kill(exitCode) in run.ts once mode, replaced proc.kill(0) with proc.kill() in plan.ts; marked PRD entry complete.
2026-02-05: Fixed stderr pipe deadlock — changed stdio from ['ignore','pipe','pipe'] to ['ignore','pipe','inherit'] in run.ts and plan.ts so stderr flows directly to the terminal instead of filling an unread pipe buffer; marked PRD entry complete.
2026-02-05: Fixed maxIterations: 0 bug — updated for-loop in run.ts to treat 0 as infinite (`maxIterations === 0 || i < maxIterations`), added `.int().nonnegative()` constraints to zod schema in config.ts; marked PRD entry complete.
2026-02-05: Fixed silent swallowing of non-Error exceptions — added else branches to all 4 catch blocks (config.ts, init.ts, run.ts x2) so non-Error thrown values (strings, objects, ZodError) are logged via String(err) and trigger process.exit(1) instead of being silently ignored; marked PRD entry complete.
2026-02-05: Made Claude --dangerously-skip-permissions flag configurable — added optional `skipPermissions` boolean (default true) to zod config schema, added confirm prompt during `ody init` when backend is claude, updated claude.ts to conditionally include the flag based on config; marked PRD entry complete.
2026-02-05: Added plan iteration loop — wrapped the entire plan flow in a while loop with a "Would you like to add another plan?" confirm prompt after each iteration; user can create multiple plans in one session or decline to exit gracefully; also handles cancel (Ctrl+C) at the confirm prompt; marked PRD entry complete.
2026-02-05: Added verbose stderr logging to run command — when --verbose is passed, stderr is piped instead of inherited and drained concurrently via an async IIFE that logs each chunk through logger.warn, preventing buffer deadlock while keeping stderr as 'inherit' when verbose is off; marked PRD entry complete.
2026-02-05: Added verbose stderr logging to plan command — mirrored the run command pattern: when --verbose is passed, stderr stdio changes from 'inherit' to 'pipe' and is drained concurrently via an async IIFE that logs each chunk through logger.warn; stderr remains 'inherit' when verbose is off; stdout completion marker detection is unaffected; marked PRD entry complete.
2026-02-10: Completed task 'Add Unit Tests for Util Modules' - Created 3 test files (constants.test.ts, stream.test.ts, inputPrompt.test.ts) with 21 passing tests covering all util modules. All tests pass via 'bun test packages/cli/src/util'.
2026-02-10: Completed task - Configurable Tasks Directory. Added tasksDir config option with default '.ody/tasks', updated LOOP_PROMPT and PLAN_PROMPT to use dynamic path substitution.
2026-02-10: Added label filter flag (-l/--label) to run command with task filtering and dry-run integration
2026-02-10: Removed confirmation prompt from plan command — removed the box() display and confirm() prompt that asked "Proceed with these plan details?" after entering a task description. Plan generation now starts immediately after the user submits their description, reducing friction. Cleaned up unused imports (box, cancel).
2026-02-10: Added `ody config` command — created packages/cli/src/cmd/config.ts that displays current configuration from .ody/ody.json using Config.all(), registered it as a subcommand in index.ts. Handles missing config gracefully with a helpful message.
2026-02-10: Added --iterations/-i flag to run command — allows overriding maxIterations config at invocation time. Validates input as non-negative integer, supports 0 for unlimited. No effect in --once mode. All validation commands pass.
2026-02-10: Added PTY-based completion detection to --once mode — replaced inherited stdio with Bun.Terminal PTY API in run.ts so the <woof>COMPLETE</woof> marker is detected and the process is killed automatically, while preserving full interactive TTY behavior for the child process.
2026-02-10: Added `plan list` subcommand — restructured plan.ts to support subcommands using citty's subCommands pattern. Existing plan creation logic preserved as default behavior (`ody plan`) and also available as `ody plan create`. New `list` subcommand reads .code-task.md files from the tasks directory, parses YAML frontmatter, and displays pending tasks with titles and filenames. Handles missing directory and no-pending-tasks cases gracefully.
2026-02-10: Added OS notifications on completion — created packages/cli/src/lib/notify.ts with cross-platform sendNotification() using osascript (macOS) and notify-send (Linux). Added `notify` config field (false | true | 'all' | 'individual') to Zod schema, --no-notify flag to run command, and notification prompt to init wizard. Notifications fire on loop completion ('all'), per iteration ('individual'), or in single-shot mode.
2026-02-10: Added global config file support — refactored Config.load() in packages/cli/src/lib/config.ts to detect and load a global config from ~/.ody/ody.json (with XDG fallback at ~/.config/ody/ody.json). Global config is merged with local project config, with local values taking precedence. Uses Bun.env.HOME with os.homedir() fallback for cross-platform home directory detection. Fully backward-compatible — existing setups without global config continue to work unchanged.
2026-02-10: Added `plan edit` subcommand — added an `edit` subcommand to the plan command that discovers .code-task.md files in the tasks directory, presents a select prompt for the user to choose a file, reads its content, constructs an edit prompt, and spawns the backend harness in build mode to edit the file. Supports --dry-run and --verbose flags. Registered as `ody plan edit` alongside existing create and list subcommands.
2026-02-10: Added task file positional argument to run command — `ody run <file>` now accepts an optional positional argument pointing to a specific .code-task.md file. When provided, the agent targets only that task (using a dedicated SINGLE_TASK_PROMPT), defaults to 1 iteration, and exits on completion. Validates file existence and extension; mutually exclusive with --label. Works in both loop and --once modes. Updated buildRunPrompt in runPrompt.ts to support the taskFile option.
2026-02-10: Added `plan compact` subcommand — archives completed tasks into a single markdown file at .ody/history/archive-{date}.md. Scans .code-task.md files, filters for status: completed, extracts titles and condensed descriptions, sorts by completion date, writes the archive, and deletes original completed task files. Handles edge cases (no tasks directory, no completed tasks, empty directory).
2026-02-12: Added configurable `agent` field to ody config — added optional `agent` string (default 'build') to the zod config schema, updated Backend.buildCommand and buildOnceCommand to read from config instead of hardcoding 'build', and added --agent/-a flag and interactive prompt to the init command for persisting the value.
2026-02-12: Added unit tests for lib directory — created packages/cli/src/lib/__tests__/ with four test files: sequencer.test.ts (pure-function incrementing counter tests), config.test.ts (Config.parse validation with valid/invalid inputs, access guard tests for all() and get()), notify.test.ts (platform-branching behavior, error swallowing, and contract tests for sendNotification), and logger.test.ts (level check, fatal reporter triggers process.exit). 35 new tests, all passing. Full suite: 56 tests across 7 files.
2026-02-13: Removed --once flag and logic from run command — deleted --once and --dry-run arg definitions and the entire PTY-based single-execution code path from run.ts, removed buildOnceCommand abstract method from Harness base class, removed buildOnceCommand from Backend facade, and removed buildOnceCommand implementations from claude.ts, opencode.ts, and codex.ts. Updated plan edit subcommand to use buildCommand with piped stdio instead of buildOnceCommand. Updated README.md to remove --once and --dry-run references. All validation commands pass (lint, fmt, typecheck).
2026-02-13: Implemented config system for Zig rewrite — created cli/src/lib/config.zig with JSON config loading, validation, global/local merge, and persistence. Defines internal JsonConfig struct (camelCase) for std.json parsing and converts to/from the idiomatic OdyConfig type. Supports polymorphic notify field (bool or string). Includes load(), all(), get(), validate(), writeConfig(), and deinit() APIs with module-level singleton. Also fixed main.zig to use Zig 0.15 std.fs.File.stdout() API. 20 unit tests, all passing. Build and test both succeed.
2026-02-13: Implemented ANSI terminal helpers for Zig rewrite — created cli/src/util/terminal.zig with color functions (red, green, yellow, cyan, gray, bold, dim, boldColor), cursor control (hideCursor, showCursor, clearLine, moveCursorUp), box framing (intro, outro, log, warn, err), and a thread-based braille Spinner struct with start/stop/setMessage. All functions accept anytype writer and an is_tty bool for TTY-aware output (escape codes suppressed on non-TTY). 26 unit tests, all passing. Build and test both succeed.
2026-02-13: Implemented task file parsing utility for Zig rewrite — created cli/src/util/task.zig with parseFrontmatter() (YAML frontmatter between --- delimiters into StringHashMap), parseTitle() (extracts # Task: ... or # ... headings), parseDescription() (extracts ## Description section condensed to 2-3 sentences), parseLabels() (comma-separated labels from **Labels**: line), getTaskFilesByLabel() (filesystem scan with case-insensitive label matching), and resolveTasksDir() (config-aware path resolution with fallback). Uses Zig 0.15 unmanaged ArrayList API. Registered in main.zig. 22 unit tests covering all functions. Syntax check and formatting clean; pre-existing errors in other modules (backend, stream) unrelated.
2026-02-13: Implemented prompt builders for Zig rewrite — created cli/src/builder/ directory with four modules: replace.zig (shared replacePlaceholder helper for find-and-replace in templates), run_prompt.zig (LOOP_PROMPT and SINGLE_TASK_PROMPT templates with buildRunPrompt supporting loop/single-task/label-filter modes), plan_prompt.zig (PLAN_PROMPT template with buildPlanPrompt for task file generation), and edit_plan_prompt.zig (EDIT_PLAN_PROMPT template with buildEditPlanPrompt for task revision). All templates ported from TypeScript with placeholder substitution for {TASKS_DIR}, {VALIDATION_COMMANDS}, {SHOULD_COMMIT}, {PROGRESS_FILE}, {CURRENT_DATE}, {TASK_DESCRIPTION}, {FILE_PATH}, {FILE_CONTENT}. Barrel module prompt.zig re-exports all builders. Wired into main.zig. Build succeeds; no builder-specific test errors.
2026-02-13: Implemented config command for Zig rewrite — created cli/src/cmd/config.zig with a `run(allocator)` function that retrieves the loaded config via `config.all()`, converts to camelCase JsonConfig via `convertToJsonConfig`, serializes to pretty-printed JSON (indent_2), and prints to stdout with terminal.log framing. Handles missing config by printing a styled warning via terminal.warn. Made JsonConfig and convertToJsonConfig public in config.zig. Wired config_cmd into main.zig module re-exports and comptime test block. Build succeeds.
2026-02-13: Implemented init command for Zig rewrite — created cli/src/cmd/init.zig with full interactive wizard: .ody/ directory creation, backend detection and autocomplete selection, model input, agent profile input, max iterations with numeric validation, validator command loop, Claude skip_permissions confirm, notification preference select, config validation via config_mod.validate(), dry-run mode (prints JSON without writing), and config persistence via config_mod.writeConfig(). Supports InitArgs struct for CLI flag overrides (-b, -i, -m, -c, -a, -n, --dry-run). Includes unit tests for validateNumeric and InitArgs defaults. Wired into main.zig. Build succeeds (zig build).

2026-02-13: Implemented run command for Zig rewrite — created cli/src/cmd/run.zig with full agent execution loop: config validation, notification setting resolution (--no-notify override), mutual exclusivity check for taskFile/--label args, task file validation (.code-task.md extension + existence check), label-based task filtering via getTaskFilesByLabel, prompt building via run_prompt.buildRunPrompt (loop/single-task/label modes), backend command building via Backend.fromConfig + buildCommand, dry-run mode (prints command array and prompt), iteration loop with configurable max (override > single-task default 1 > config), spinner animation for non-verbose mode, concurrent stdout/stderr draining via runPipedCommand, completion marker detection (<woof>COMPLETE</woof>), individual and all notification modes via sendNotification, error handling with spinner cleanup. Wired run_cmd into main.zig module re-exports and comptime test block. Build succeeds (zig build).

2026-02-13: Implemented plan list and plan compact commands for Zig rewrite — created cli/src/cmd/plan/list.zig and cli/src/cmd/plan/compact.zig. Plan list: accepts --status/-s flag (default "pending"), scans .code-task.md files in configured tasks dir, parses YAML frontmatter to filter by status, displays matching tasks with bold titles and dimmed filenames, sorted alphabetically, with count summary or "No X tasks." message. Plan compact: scans for completed tasks with non-null completion date, extracts title/description/date into CompletedTask structs, sorts by completion date ascending, generates markdown archive document with task summaries, writes to .ody/history/archive-YYYY-MM-DD.md (creating directory if needed), deletes original completed task files, prints archive summary. Both use Zig 0.15 unmanaged ArrayList pattern (.{} init, allocator passed to methods). Wired plan_list_cmd and plan_compact_cmd into main.zig module re-exports and comptime test block. No compilation errors in new files (pre-existing errors remain in other in-progress modules).

2026-02-13: Implemented plan new command for Zig rewrite — created cli/src/cmd/plan/new.zig with full interactive task creation loop: config validation guard, intro/outro framing, text prompt for task description with non-empty validation (validateNonEmpty rejects empty and whitespace-only input), plan prompt building via plan_prompt.buildPlanPrompt, dry-run mode (prints prompt without spawning backend), tasks directory creation via makePath, backend command building via buildOnceCommand, spinner animation for non-verbose mode, concurrent stdout/stderr draining via runPipedCommand with completion marker detection (checkCompletion callback), confirm prompt to loop for additional plans, graceful cancellation handling. Supports NewArgs struct with --dry-run and --verbose flags. Includes 7 unit tests for NewArgs defaults, validateNonEmpty, and checkCompletion. Wired plan_new_cmd into main.zig module re-exports and comptime test block. Build succeeds (zig build exit 0). Pre-existing test failures in other modules (ArrayList API, process spawning API changes for Zig 0.15) are unrelated.

2026-02-13: Implemented plan edit command for Zig rewrite — created cli/src/cmd/plan/edit.zig with full interactive task editing flow: config validation guard, intro/outro framing, tasks directory scanning for .code-task.md files, frontmatter parsing to filter only pending tasks, title extraction for display labels, alphabetically sorted select prompt via selectPrompt(usize), cancellation handling, selected file content reading, edit plan prompt building via edit_plan_prompt.buildEditPlanPrompt with file path and content substitution, dry-run mode (prints prompt without spawning backend), backend command building via buildOnceCommand, spinner animation for non-verbose mode, concurrent stdout/stderr draining via runPipedCommand with completion marker detection (checkCompletion callback), exit code validation, success/failure messaging. Supports EditArgs struct with --dry-run and --verbose flags. Includes 3 unit tests for EditArgs defaults and checkCompletion. Wired plan_edit_cmd into main.zig module re-exports and comptime test block. Build succeeds (zig build exit 0). Pre-existing test failures in other modules are unrelated.
2026-02-13: Created Zig CI pipeline and updated AGENTS.md — added .github/workflows/zig-ci.yml with three jobs (lint via zig fmt --check, test via zig build test, build with native ReleaseSafe and cross-compilation matrix), triggered on push/PR to main when cli/** files change, using mlugg/setup-zig@v1 with Zig 0.15.0. Rewrote AGENTS.md to fully reflect the Zig project structure, commands, conventions, and CI pipeline, removing all TypeScript/Bun/npm/citty/Zod references. Added Zig-specific guidance for error handling, memory management, tagged unions, comptime, allocator patterns, and testing conventions.

2026-02-14: Renamed plan subcommands to task and promoted plan new to root plan — restructured CLI command hierarchy so that `plan list`, `plan edit`, and `plan compact` become `task list`, `task edit`, and `task compact`, while `plan new` is promoted to `ody plan` (leaf command with --dry-run/--verbose flags). Created cli/src/cmd/task/ directory with list.zig, edit.zig, compact.zig (copies of plan versions with updated doc comments and user-facing strings referencing `ody plan` instead of `ody plan new`). Added `task` to Command enum, created TaskSubcommand enum (list, edit, compact), implemented runTask() dispatcher with runTaskList() and runTaskEdit() argument parsers. Converted runPlan() from subcommand router to leaf command calling plan_new_cmd.run() directly. Removed PlanSubcommand enum. Updated all help text: top-level shows `plan` as "Create a new task plan interactively" and `task` as "Manage tasks (list, edit, compact)". Added printTaskUsage() help function. Updated module re-exports (task_util, task_list_cmd, task_compact_cmd, task_edit_cmd) and comptime test discovery block. Marked legacy cmd/plan/ modules with deprecation doc comments. Updated cross-module references in spawn.zig and types.zig. Build succeeds (zig build), formatting clean (zig fmt --check src/).

2026-02-14: Introduced Just as project script runner — created justfile at repository root with `set working-directory := "cli"` directive. Recipes: default (list all recipes), build (debug), build-release (ReleaseSafe), test (unit tests), run (with variadic arg forwarding), fmt (auto-format), fmt-check (CI-style format verification). All recipes verified working from project root. Developers can now run `just build`, `just test`, etc. from the repo root instead of cd-ing into cli/.

2026-02-14: Fixed leading "+" in created frontmatter date — changed `year` type in `currentDateString()` from `i32` to `u16` in cli/src/builder/plan_prompt.zig:140. The signed integer caused Zig's zero-padded format specifier to prepend a `+` sign to positive year values (e.g., `+2026-02-15` instead of `2026-02-15`). Using the native unsigned `u16` type from `calculateYearDay().year` eliminates the sign prefix. All existing tests pass (169/170; 1 pre-existing unrelated failure in terminal.zig).

2026-02-14: Fixed text input line-wrap duplication bug — added getTerminalWidth() (POSIX ioctl TIOCGWINSZ with 80-col fallback), computeVisualRows() helper, and clearMultipleLines() to cli/src/util/terminal.zig. Updated renderTextLine() in cli/src/util/prompt.zig to accept/return a prev_rows count and clear all wrapped visual rows before redrawing. Updated the text() event loop to track prev_rows across keystrokes and clear all wrapped rows on enter (submit/validation-error) and cancel (Ctrl+C/Escape). Non-TTY mode unaffected (always returns 1 row). Added 12 new unit tests across both files. Build succeeds; 181/182 tests pass (1 pre-existing failure in terminal.zig outro test).
